static void (^removeChildViewControllers)(NSArray<__kindof UIViewController *> *) = ^(NSArray<__kindof UIViewController *> *childViewControllers) {
    for (__kindof UIViewController * childViewController in childViewControllers) {
        [childViewController willMoveToParentViewController:nil];
        [[childViewController view] removeFromSuperview];
        [childViewController removeFromParentViewController];
    }
};

static void (^addChildViewControllerToParent)(__weak __typeof__(UIViewController * _Nonnull), __weak __typeof__(UIViewController * _Nonnull)) = ^(__weak __typeof__(UIViewController * _Nonnull)w_childViewController, __weak __typeof__(UIViewController * _Nonnull)w_parentViewController) {
    __strong __typeof__ (UIViewController *) s_parentViewController = w_parentViewController;
    __strong __typeof__ (UIViewController *) s_childViewController = w_childViewController;
    
    dispatch_async(dispatch_get_main_queue(), ^{
        removeChildViewControllers([s_parentViewController childViewControllers]);
        
        [s_parentViewController addChildViewController:s_childViewController];
        [s_childViewController didMoveToParentViewController:s_parentViewController];
        
        // match the child size to its parent
        CGRect frame = s_childViewController.view.frame;
        frame.size.height = CGRectGetHeight(((RootMessagesViewController *)s_parentViewController).view.frame);
        frame.size.width = CGRectGetWidth(((RootMessagesViewController *)s_parentViewController).view.frame);
        s_childViewController.view.frame = frame;
        
        [((RootMessagesViewController *)s_parentViewController).view addSubview:s_childViewController.view];
        
        if ([s_childViewController isKindOfClass:[ExpandedMessagesViewController class]])
            [(ExpandedMessagesViewController *)s_childViewController setDelegate:(id <ExpandedMessagesViewControllerDelegate>)s_parentViewController];
    });
};



static MSMessagesAppPresentationStyle (^presentationStyleFromAssociatedProperty)(NSString *) = ^MSMessagesAppPresentationStyle (NSString *associatedProperty) {
    MSMessagesAppPresentationStyle presentationStyle = ([associatedProperty isEqualToString:CompactMessagesViewControllerStoryboardID] ||
                                                        [associatedProperty isEqualToString:CompactMessagesViewControllerPresentationStyle])
                                                        ?
                                                            MSMessagesAppPresentationStyleCompact
                                                        :
                                                       ([associatedProperty isEqualToString:CompactMessagesViewControllerStoryboardID] ||
                                                        [associatedProperty isEqualToString:CompactMessagesViewControllerPresentationStyle])
                                                        ?
                                                            MSMessagesAppPresentationStyleExpanded
                                                        :
                                                            MSMessagesAppPresentationStyleCompact;
    
    return presentationStyle;
};

typedef NS_ENUM(NSUInteger, AssociatedPropertyType) {
    AssociatedPropertyTypeStoryboardID,
    AssociatedPropertyTypePresentationStyle
};

static NSString * (^associatedPropertyForPresentationStyle)(AssociatedPropertyType, MSMessagesAppPresentationStyle) = ^ NSString * (AssociatedPropertyType type, MSMessagesAppPresentationStyle presentationStyle) {
    return
    
    (presentationStyle == MSMessagesAppPresentationStyleCompact)
    ?
    (type == AssociatedPropertyTypeStoryboardID) ? CompactMessagesViewControllerStoryboardID : CompactMessagesViewControllerPresentationStyle
    :
    (type == AssociatedPropertyTypeStoryboardID) ? ExpandedMessagesViewControllerStoryboardID : ExpandedMessagesViewControllerPresentationStyle;
    
};

- (UIViewController *)initChildViewControllerWithAssociatedProperty:(NSString *)associatedProperty
{
    UIViewController * childViewController = nil;
    MSMessagesAppPresentationStyle presentationStyle = presentationStyleFromAssociatedProperty(associatedProperty);
    switch (presentationStyle) {
        case MSMessagesAppPresentationStyleCompact: {
            self.compactMessagesViewController = (CompactMessagesViewController *)[self.storyboard instantiateViewControllerWithIdentifier:CompactMessagesViewControllerStoryboardID];
            [self.compactMessagesViewController setDelegate:(id<CompactMessagesViewControllerDelegate>)self];
            childViewController = self.compactMessagesViewController;
            break;
        }
        case MSMessagesAppPresentationStyleExpanded: {
            self.expandedMessagesViewController = (ExpandedMessagesViewController *)[self.storyboard instantiateViewControllerWithIdentifier:ExpandedMessagesViewControllerStoryboardID];
            [self.expandedMessagesViewController setDelegate:(id<ExpandedMessagesViewControllerDelegate>)self];
            childViewController = self.expandedMessagesViewController;
            break;
        }
        default:
            break;
    }
    
    return childViewController;
}

- (typeof (UIViewController *))childViewControllerForAssociatedProperty:(NSString *)associatedProperty
{
    return
    
    ([associatedProperty isEqualToString:CompactMessagesViewControllerStoryboardID] ||
     [associatedProperty isEqualToString:CompactMessagesViewControllerPresentationStyle])
    ?
        (!self.compactMessagesViewController)
        ?
            (CompactMessagesViewController *)[self initChildViewControllerWithAssociatedProperty:CompactMessagesViewControllerStoryboardID]
        :
            (CompactMessagesViewController *)self.compactMessagesViewController
    :
    ([associatedProperty isEqualToString:ExpandedMessagesViewControllerStoryboardID] ||
     [associatedProperty isEqualToString:ExpandedMessagesViewControllerPresentationStyle])
    ?
        (!self.expandedMessagesViewController)
        ?
            (ExpandedMessagesViewController *)[self initChildViewControllerWithAssociatedProperty:ExpandedMessagesViewControllerStoryboardID]
        :
            (ExpandedMessagesViewController *)self.expandedMessagesViewController
    : nil;
}

// Called by the root view controller at initialization and
// by all view controllers to transition between presentation styles
//- (void)presentChildViewControllerWithAssociatedProperty:(NSString *)associatedProperty {
//    NSLog(@"Switching to %@\n", associatedProperty);
//    typeof(UIViewController *) presentingChildViewController = [self childViewControllerForAssociatedProperty:associatedProperty];
//
//    // add NSNumber to UIViewController for presentation style
//    // use accessor methods to get and set (like count for NSArray)
//
//    if (self.childViewControllers.count > 0) {
//        NSLog(@"Removing %@", self.childViewControllers.firstObject);
//        typeof(UIViewController *) presentedChildViewController = self.childViewControllers.firstObject;
//        [self.view willRemoveSubview:presentedChildViewController.view];
//        [presentedChildViewController.view removeFromSuperview];
//        [presentedChildViewController willMoveToParentViewController:nil];
//        [presentedChildViewController removeFromParentViewController];
//        [presentedChildViewController didMoveToParentViewController:self];
//    }
//
//    [presentingChildViewController willMoveToParentViewController:self];
//    [self addChildViewController:presentingChildViewController];
//    [presentingChildViewController didMoveToParentViewController:self];
//
//    [presentingChildViewController.view willMoveToSuperview:self.view];
//    [self.view addSubview:presentingChildViewController.view];
//    [self.view didAddSubview:presentingChildViewController.view];
//
//    presentingChildViewController.view.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight;
//    presentingChildViewController.view.frame = CGRectMake(0, 0, self.view.frame.size.width, self.view.frame.size.height);
//    [presentingChildViewController.view willMoveToSuperview:self.view];
//
//
//    NSLog(@"Switched to %@\n", associatedProperty);
//    NSLog(@"Number of child view controllers: %lu", self.childViewControllers.count);
//}
//
//- (void)swapChildViewControllers {
//    NSLog(@"---------------");
//    NSLog(@"Swapping out %@", self.childViewControllers.firstObject.restorationIdentifier);
//    dispatch_async(dispatch_get_main_queue(), ^{
//        [self presentChildViewControllerWithAssociatedProperty:([self.childViewControllers.firstObject.restorationIdentifier isEqualToString:CompactMessagesViewControllerStoryboardID])
//                                                                ?
//                                                                    ExpandedMessagesViewControllerStoryboardID
//                                                                :
//                                                                    ([self.childViewControllers.firstObject.restorationIdentifier isEqualToString:ExpandedMessagesViewControllerStoryboardID])
//                                                                    ?
//                                                                        CompactMessagesViewControllerStoryboardID
//                                                                    :   ExpandedMessagesViewControllerStoryboardID];
//    });
//}
//

    __weak __typeof__ (self) w_self = self;

//    resizeTextViewFrameToUsedRectForTextContainer(self.messageTextView, self.renderCipherImageButton);
//- (void)textViewDidChange:(UITextView *)textView {
////    CGFloat messageTextViewFrameHeight = self.messageTextView.frame.size.height;
////    CGFloat messageTextViewContentHeight = [self.messageTextView.textContainer.layoutManager usedRectForTextContainer:self.messageTextView.textContainer].size.height;
////    if (messageTextViewContentHeight != messageTextViewFrameHeight) {
////        resizeTextViewFrameToUsedRectForTextContainer(textView, self.renderCipherImageButton);
////    }
//}


static void (^excludeButtonFrameFromTextView)(UIButton * _Nullable, UITextView * _Nullable) = ^ (UIButton * _Nullable button, UITextView * _Nullable textView) {
    dispatch_async(dispatch_get_main_queue(), ^{
        UIBezierPath * exclusionPath = [UIBezierPath bezierPathWithRect:button.frame];
        textView.textContainer.exclusionPaths = @[exclusionPath];
    });
};


//    NSString *outputPath = [NSString stringWithFormat:@"%@%@", NSTemporaryDirectory(), @"output.png"];
//    __autoreleasing NSError * fileWriteError = nil;
//    if (![UIImagePNGRepresentation(cipherImageFile()) writeToFile:outputPath options:NSDataWritingAtomic error:&fileWriteError]) {
//        NSLog(@"Failed to write image to file: %@", fileWriteError.description);
//    } else {
//        __autoreleasing NSError * stickerInitError = nil;
//        NSURL * fileURL = [NSURL fileURLWithPath:outputPath];
//        MSSticker * cipherSticker = [[MSSticker alloc] initWithContentsOfFileURL:fileURL localizedDescription:@"The cipher sticker" error:&stickerInitError];
//        if (!stickerInitError) {
//            MSConversation * conversation = self.activeConversation;
//            [conversation insertSticker:cipherSticker completionHandler:^(NSError * _Nullable insertStickerError) {
//                if (insertStickerError) NSLog(@"Failed to insert cipher sticker into the current conversation");
//            }];
//        } else {
//            NSLog(@"Failed to create the cipher sticker: %@", stickerInitError.description);
//        }
//    }


//        UIImage *image = [UIImage imageWithContentsOfFile:fileURL.absoluteString];
//        [templateLayout setMediaFileURL:fileURL];
//        [templateLayout setImage:image];
//        [templateLayout setCaption:@"Message encrypted in undecipherable image"];
//        [templateLayout setImageTitle:@"Cipher image"];



    NSString *outputPath = [NSString stringWithFormat:@"%@%@", NSTemporaryDirectory(), @"output.png"];
    __autoreleasing NSError * fileWriteError = nil;
    if (![UIImagePNGRepresentation(cipherImageFile()) writeToFile:outputPath options:NSDataWritingAtomic error:&fileWriteError]) {
        NSLog(@"Failed to write image to file: %@", fileWriteError.description);
    } else {
        NSURL * fileURL = [NSURL fileURLWithPath:outputPath];
        [self.activeConversation sendAttachment:fileURL withAlternateFilename:outputPath completionHandler:^(NSError * _Nullable error) {
            if (error) NSLog(@"Error: %@", error.debugDescription);
            
        }];
    }

    UIImage * image = [templateLayout image];
    CIImage *inputImage = [CIImage imageWithCGImage:image.CGImage];
    inputImage = [inputImage imageByApplyingCGOrientation:kCGImagePropertyOrientationUp];
    CIFilter *filter = [CIFilter filterWithName:@"CIGaussianBlur"];
    [filter setDefaults];
    [filter setValue:inputImage forKey:kCIInputImageKey];
    [filter setValue:@(15.0) forKey:kCIInputRadiusKey];
    CIImage *outputImage = [filter outputImage];
    UIImage * cipherImageFile = [UIImage imageWithCIImage:outputImage];
    [(MSMessageTemplateLayout *)conversation.selectedMessage.layout setImage:cipherImageFile];
